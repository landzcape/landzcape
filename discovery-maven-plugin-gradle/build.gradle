import groovy.json.JsonSlurper
import groovy.json.JsonOutput
import org.gradle.internal.os.OperatingSystem

task mvnBuild(type: Exec, dependsOn: [':domain:install', ':web:install']) {
    standardOutput = new ByteArrayOutputStream()
    errorOutput = new ByteArrayOutputStream()
    workingDir "${projectDir}/../discovery-maven-plugin"
    commandLine osAdaptiveCommand('mvnw', 'clean', 'install')
    doLast {
        println standardOutput.toString()
        println errorOutput.toString()
    }
}

task integrationTestBigMultiModule(type:Exec, dependsOn: mvnBuild ) {
    standardOutput = new ByteArrayOutputStream()
    errorOutput = new ByteArrayOutputStream()
    workingDir "${projectDir}/integration-test/big-multi-module"
    commandLine osAdaptiveCommand('mvnw', 'clean', 'install')
    doLast {
        println standardOutput.toString()
        println errorOutput.toString()
        assertLandscapeJsonIsAsExpected("big-multi-module")
    }
}

task integrationTestMerger(type:Exec, dependsOn: mvnBuild ) {
    standardOutput = new ByteArrayOutputStream()
    errorOutput = new ByteArrayOutputStream()
    workingDir "${projectDir}/integration-test/merger"
    commandLine osAdaptiveCommand('mvnw', 'clean', 'install')
    doLast {
        println standardOutput.toString()
        println errorOutput.toString()
        assertLandscapeJsonIsAsExpected("merger")
    }
}

task integrationTestExtractWebApp(type:Exec, dependsOn: mvnBuild ) {
    def targetDir = new File("${projectDir}/integration-test/extract")
    def appDir = new File(targetDir, "the-app")
    appDir.deleteDir()
    appDir.mkdir()
    standardOutput = new ByteArrayOutputStream()
    errorOutput = new ByteArrayOutputStream()
    workingDir "${projectDir}/integration-test/extract"
    commandLine osAdaptiveCommand('mvnw', 'clean', 'install')
    doLast {
        println standardOutput.toString()
        println errorOutput.toString()
        assert new File(appDir, "index.html").exists()
    }
}

def assertLandscapeJsonIsAsExpected(mvnProjectName) {
    def dir = "${projectDir}/integration-test/${mvnProjectName}"
    def generatedLandscape = file("${dir}/landscape.json")
    def expectedLandscape = file("${dir}/expected-landscape.json")
    assert readJson(generatedLandscape) == readJson(expectedLandscape) : "${mvnProjectName}/landscape.json differs from expectation"
}

def readJson(file) {
    def slurper = new JsonSlurper()
    return JsonOutput.prettyPrint(JsonOutput.toJson(slurper.parse(file)))
}

def osAdaptiveCommand(String command, String... parameters) {
    def newCommands = []
    if (OperatingSystem.current().isWindows()) {
        newCommands.addAll(['cmd', '/c', command])
    } else {
        newCommands.add('./'+command)
    }
    newCommands.addAll(parameters)
    return newCommands
}

test.dependsOn integrationTestBigMultiModule
test.dependsOn integrationTestMerger
test.dependsOn integrationTestExtractWebApp
build.dependsOn mvnBuild